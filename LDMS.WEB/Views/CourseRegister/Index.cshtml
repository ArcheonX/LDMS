
@{
    ViewData["Title"] = "Course Register";
    ViewData["MainTitle"] = "I-Manage";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section Header{

    <link href="~/lib/bootstrap-datepicker/css/bootstrap-datepicker.css" rel="stylesheet" />
    <script src="~/lib/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
    <style>
        .ui-widget-header {
            border-color: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
        }

        .btn-command {
            width: 130px !important;
        }

        .chk {
            color: transparent !important;
        }

        .text-grid {
            width: 90px;
        }

        .modal-dialog {
            -webkit-transform: translate(0,-50%);
            -o-transform: translate(0,-50%);
            transform: translate(0,-50%);
            margin: 0 auto;
        }

        .hide-cell {
            border-width: 0px !important;
        }

        thead th {
            text-align: center;
        }

        .label-gray {
            background-color: #b3b3b3;
        }
    </style>
}


<div class="card card-outline-success">
    <form method="post" id="frmCR">
        @Html.AntiForgeryToken()
        <div class="card-header">
            <h4 class="m-b-0 text-white">Course Information</h4>
        </div>
        <div class="card-block p-4">
            <div class="form-group row">
                <div class="col-8">
                    <small class="text-muted">Class</small>
                    <h6 id="lblClassName"></h6>
                </div>
                <div class="col-4 row">
                    <div class="col-3">
                        <small class="text-muted">Status</small>
                        <h6 id="lblStatus"></h6>
                    </div>
                </div>
            </div>
            <hr />
            <div class="form-group row">
                <div class="col-1">
                    <a href="javascript:void(0)" class="link">
                        <small class="text-success font-bold">Capacity</small><br />
                        <i class="icon-people"></i>
                        <font class="font-medium" id="lblNCap"></font>
                    </a>
                </div>
                <div class="col-1">
                    <a href="javascript:void(0)" class="link">
                        <small class="text-danger font-bold">Register</small><br />
                        <i class="icon-people"></i>
                        <font class="font-medium" id="lblNRegis"></font>
                    </a>
                </div>
                <div class="col-1">
                    <a href="javascript:void(0)" class="link">
                        <small class="text-muted font-bold">Waiting</small><br />
                        <i class="icon-people"></i>
                        <font class="font-medium" id="lblNWait"></font>
                    </a>
                </div>
            </div>

            <hr />
            <div class="form-group row pt-2 pb-1">
                <div class="col-2">
                    <small class="text-muted">Employee ID</small>
                    <input type="text" maxlength="100" class="form-control" id="txtEmpID" />
                </div>
                <div class="col-3">
                    <small class="text-muted">Employee Name</small>
                    <input type="text" maxlength="100" class="form-control" id="txtEmpName" />
                </div>
                <div class="col-3">
                    <small class="text-muted">Department</small>
                    <input type="text" maxlength="100" class="form-control" id="txtDept" />
                </div>
                <div class="col-3" style="padding-top: 25px;">
                    <button type="button" id="btnCSearch" class="btn btn-primary btn-command">Search</button>
                </div>
            </div>
            <div class="form-group row pt-2 pb-1">
                <div class="col-6">
                    <div class="btn-group" role="group" aria-label="Command">
                        <button type="button" id="btnApprove" class="btn btn-sm btn-info btn-command">Approve</button>
                        <button type="button" id="btnReject" class="btn btn-sm btn-danger btn-command">Reject</button>
                        <button type="button" id="btnClose" class="btn btn-warning btn-command">Close</button>
                    </div>
                </div>
                <div class="col-6 text-right">
                    <div class="btn-group" role="group" aria-label="Command">
                        <button type="button" id="btnSave" class="btn btn-sm btn-primary btn-command">Save</button>
                        <button type="button" id="btnBack" class="btn btn-sm btn-warning btn-command">Back</button>
                    </div>
                </div>
            </div>

            <div class="table-responsive m-t-40">
                <table id="tbCourse" class="table table-hover table-bordered color-table info-table" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <td class="hide-cell"></td>
                            <td class="hide-cell"></td>
                            <td class="hide-cell"></td>
                            <td class="hide-cell"></td>
                            <td class="hide-cell"></td>
                            <td class="hide-cell"></td>
                            <td class="text-center hide-cell"><span id="lblSRegister" class="label label-success">&nbsp;</span></td>
                            <td class="text-center hide-cell"><span id="lblSAttend" class="label label-warning">&nbsp;</span></td>
                            <td class="text-center hide-cell"><span id="lblSPre" class="label label-gray">&nbsp;</span></td>
                            <td class="text-center hide-cell"><span id="lblSPost" class="label label-gray">&nbsp;</span></td>
                            <td class="hide-cell"></td>
                            <td class="text-center hide-cell"><span id="lblSSkill" class="label label-gray">&nbsp;</span></td>
                            <td class="hide-cell"></td>
                            <td class="text-center hide-cell"><span id="lblSCoach" class="label label-gray">&nbsp;</span></td>
                            <td class="text-center hide-cell"><span id="lblSCert" class="label label-inverse">&nbsp;</span></td>
                            <td class="text-center hide-cell"><span id="lblSStatus" class="label label-gray">&nbsp;</span></td>
                        </tr>
                        <tr>
                            <th class="text-center"><input type="checkbox" id="chkAll" /><label for="chkAll" class='chk'>.</label></th>
                            <th>#</th>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Job Grade</th>
                            <th>Register</th>
                            <th>Attend</th>
                            <th>Pre-Test</th>
                            <th>Post-Test</th>
                            <th>%</th>
                            <th>Skill</th>
                            <th>%</th>
                            <th>Coaching</th>
                            <th style="width:120px;">Certificate</th>
                            <th style="min-height:53px;min-width:96px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

        </div>
    </form>
</div>

<div class="modal" id="modEmp_Close" tabindex="-1" role="dialog" aria-labelledby="modAlertLabel" aria-hidden="false"  data-keyboard="false">
    <div class="modal-dialog modal-lg" style="display:table;height: 100%;width: 1200px !important;">
        <div class="modal-content">
            <div class="modal-header card-header col-12">
                <h4 class="modal-title col-10" id="lblMATitle">Select Waiting List to Approve Register</h4>
                <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body" style="min-height: 80px;">
                <div class="col-12" style="overflow-y:auto;height:400px;">
                    <table id="tbREmp" class="table color-table info-table" style="font-size:10pt;">
                        <thead>
                            <tr>
                                <th class="text-center"><input type="checkbox" id="chkEAll" /><label for="chkEAll" class='chk'>.</label></th>
                                <th>#</th>
                                <th>Employee ID</th>
                                <th>Employee Name</th>
                                <th>Department</th>
                                <th>Section</th>
                                <th>Job Grade</th>
                                <th>Job Title</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col-12 row">
                    <div class="col-9">
                        <button type="button" id="btnRegisterR" class="btn btn-info btn-command">Register</button>
                        <button type="button" id="btnBackR" class="btn btn-secondary btn-command" formnovalidate data-dismiss="modal">Close</button>
                    </div>
                    <div class="col-3">
                        <button type="button" id="btnCloseRS" class="btn btn-primary">Close Register</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modCert" tabindex="-1" role="dialog" aria-labelledby="modAlertLabel" aria-hidden="false"  data-keyboard="false">
    <div class="modal-dialog modal-lg" style="display:table;height: 100%;">
        <div class="modal-content">
            <div class="modal-header card-header col-12">
                <h4 class="modal-title col-10" id="lblMATitle">Confirm Certificate</h4>
                <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
            </div>
            <form id="frmCert" class="form" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body" style="min-height: 80px;">
                    <div class="col-12" style="height:200px;">

                        <div class="form-group row col-md-12" style="padding-top:20px;">
                            <small class="text-muted">Expire Date <span class="text-danger">*</span></small>
                            <input class="form-control" type="date" id="dpcCertExpire" data-date="" data-date-format="DD/MM/YYYY" name="expireDate">
                        </div>
                        <div class="form-group row col-md-12" style="padding-top:20px;">
                            <small class="text-muted">Certificate <span class="text-danger">*</span></small>
                            <input type="file" id="fiCert" name="fiCert" accept="application/pdf" />
                        </div>
                        <div class="form-group row col-md-12" style="padding-top:20px;">
                            <a id="aFile" target="_blank" class="btn btn-primary btn-sm btn-command">Download</a>
                        </div>
                        <input type="hidden" id="hdCertClass" name="classID" value="@ViewData["class"]" />
                        <input type="hidden" id="hdCertCourse" name="courseID" value="@ViewData["course"]" />
                        <input type="hidden" id="hdCertEmp" name="employeeID" />
                    </div>
                </div>
                <div class="modal-footer" style="padding-top:20px;">
                    <div class="col-12 row">
                        <input type="submit" id="btnCertSave" class="btn btn-info btn-command" value="Save" />&nbsp;&nbsp;
                        <button type="button" id="btnCertBack" class="btn btn-secondary btn-command" formnovalidate data-dismiss="modal">Close</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<input type="hidden" id="hdClass" />
<input type="hidden" id="hdCourse" />

<input type="hidden" id="hdStatus" />
<input type="hidden" id="hdAttend" />
<input type="hidden" id="hdAttend1" />
<input type="hidden" id="hdTest" />
<input type="hidden" id="hdTest1" />
<input type="hidden" id="hdTest2" />
<input type="hidden" id="hdSkill" />
<input type="hidden" id="hdSkill1" />
<input type="hidden" id="hdSkill2" />
<input type="hidden" id="hdCoach" />
<input type="hidden" id="hdCert" />

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            LoadClass();
        });

        $("#txtEmpID").on('keyup', function (e) {
            if (e.keyCode === 13) {
                SearchCR();
            }
        });

        $("#txtEmpName").on('keyup', function (e) {
            if (e.keyCode === 13) {
                SearchCR();
            }
        });

        $("#txtDept").on('keyup', function (e) {
            if (e.keyCode === 13) {
                SearchCR();
            }
        });

        $("#btnCSearch").click(function (e) {
            e.preventDefault();
            SearchCR();
        });

        $("#btnApprove").click(function(){
            if(confirm('@LDMS.WEB.Resources.Message.e_CourseRegister_ConfirmApprove'))
            {
                var list = "";
                $('.scr').not("[disabled]").each(function () {
                    if(this.checked)
                    {
                        list += this.alt+",";
                    }
                });
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateRegisStatusA", "CourseRegister")',
                    data: { "classID": "@ViewData["class"]",
                            "courseID": "@ViewData["course"]",
                            "idList": list,
                            "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                    success: function (e) {
                        SearchCR();
                     },
                });
            }
        });

        $("#btnReject").click(function(){
            if(confirm('@LDMS.WEB.Resources.Message.e_CourseRegister_ConfirmReject'))
            {
                var list = "";
                $('.scr').not("[disabled]").each(function () {
                    if(this.checked)
                    {
                        list += this.alt+",";
                    }
                });
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateRegisStatusR", "CourseRegister")',
                    data: { "classID": "@ViewData["class"]",
                            "courseID": "@ViewData["course"]",
                            "idList": list,
                            "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                    success: function (e) {
                        SearchCR();
                     },
                });
            }
        });


        $("#chkEAll").change(function() {
            var checked_status = this.checked;
            $('.scr-e').not("[disabled]").each(function () {
                   this.checked = checked_status;
            });
        });


        $("#btnClose").click(function () {
            $('#modEmp_Close').modal('toggle');
            SearchEmpForClose();
        });

        function SearchEmpForClose()
        {
            $("#tbREmp tbody > tr").remove();
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetEmployeeClose", "CourseRegister")',
                data: { "classID": "@ViewData["class"]",
                        "courseID": "@ViewData["course"]",
                        "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                success: function (e) {
                    if (e != null) {
                        for (var i = 0; i < e.length; i++) {
                            var row = $("<tr />");
                            $("#tbREmp tbody").append(row);

                            row.append("<td class='text-center'><input type='checkbox' class='scr-e' id='chkED" + e[i].EmployeeID +
                                "' alt='" + e[i].EmployeeID + "' /><label class='chk' for='chkED" + e[i].EmployeeID +"'>.</label> </td>");
                            row.append($("<td class='text-center'>" + (i + 1) + "</td>"));
                            row.append($("<td class='text-center'>" + e[i].EmployeeID + "</td>"));
                            row.append($("<td>" + e[i].Name + " " + e[i].Surname + "</td>"));
                            row.append($("<td>" +  e[i].DepartmentName_TH + "</td>"));
                            row.append($("<td>" +  e[i].SectionName_TH + "</td>"));
                            row.append($("<td>" +  e[i].JobGradeName_TH + "</td>"));
                            row.append($("<td>" +  e[i].JobTitleName_TH + "</td>"));
                        }
                    }
                },
            });
        }

        $("#btnRegisterR").click(function(){
            if(confirm('@LDMS.WEB.Resources.Message.e_CourseRegister_ConfirmApprove'))
            {
                var list = "";
                $('.scr-e').not("[disabled]").each(function () {
                    if(this.checked)
                    {
                        list += this.alt+",";
                    }
                });
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateRegisStatusA", "CourseRegister")',
                    data: { "classID": "@ViewData["class"]",
                            "courseID": "@ViewData["course"]",
                            "idList": list,
                            "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                    success: function (e) { SearchEmpForClose();SearchCR(); },
                });
            }
        });

        $("#btnCloseRS").click(function(){
            if(confirm('@LDMS.WEB.Resources.Message.e_CourseRegister_ConfirmClose'))
            {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("CloseClass", "CourseRegister")',
                    data: { "classID": "@ViewData["class"]",
                            "courseID": "@ViewData["course"]",
                            "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                    success: function (e) { LoadClass(); SearchCR();$('#modEmp_Close').modal('toggle'); },
                });
            }
        });

        $("#btnBack").click(function(){
            window.location.href = '@Url.Content("~/Courses/Detail/"+ViewData["course"])';
        });

        function LoadClass() {
            $.ajax({
                type: 'POST',
                 url: '@Url.Action("GetInfo", "CourseRegister")',
                data: { "ClassID": "@ViewData["class"]", "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                success: function (e) {
                     if (e.length > 0) {
                        $("#lblClassName").html(e[0].ClassID + " " + e[0].CourseName);
                        $("#lblStatus").html(e[0].ClassStatus_Name);
                        $("#lblNCap").html(e[0].ClassCapacity);
                        $("#lblNRegis").html(e[0].Register_Count);
                        $("#lblNWait").html(e[0].Waiting_Count);

                        $("#hdStatus").val(e[0].ClassStatus);

                        var all_Count = e[0].All_Count;
                        if(e[0].Qualified_Count >= all_Count) $("#lblSStatus").attr('class',"label label-success");

                        $("#hdAttend").val(e[0].IsAttend);

                        if(e[0].IsAttend == "1")
                        {   if(e[0].Attend_Count >= all_Count) $("#lblSAttend").attr('class',"label label-success");
                            else if ( e[0].Attend_Count > 0) $("#lblSAttend").attr('class',"label label-warning");
                            else $("#lblSAttend").attr('class',"label label-gray"); }
                        else{ $("#lblSAttend").attr('class',"label label-inverse"); }

                        $("#hdAttend1").val(e[0].AttendNum);
                        $("#hdTest").val(e[0].IsTest);
                        if(e[0].IsTest == "1")
                        {
                            if(e[0].PreTest_Count >= all_Count) $("#lblSPre").attr('class',"label label-success");
                            else if ( e[0].PreTest_Count > 0) $("#lblSPre").attr('class',"label label-warning");
                            else $("#lblSPre").attr('class',"label label-gray");

                            if(e[0].PostTest_Count >= all_Count) $("#lblSPost").attr('class',"label label-success");
                            else if ( e[0].PostTest_Count > 0) $("#lblSPost").attr('class',"label label-warning");
                            else $("#lblSPost").attr('class',"label label-gray");
                        }
                        else{ $("#lblSPre").attr('class',"label label-inverse"); $("#lblSPost").attr('class',"label label-inverse");}

                        $("#hdTest1").val(e[0].TestFullScore);
                        $("#hdTest2").val(e[0].TestPercentage);
                        $("#hdSkill").val(e[0].IsSkill);
                        if(e[0].IsSkill == "1")
                        {
                            if(e[0].Skill_Count >= all_Count) $("#lblSSkill").attr('class',"label label-success");
                            else if ( e[0].Skill_Count > 0) $("#lblSSkill").attr('class',"label label-warning");
                            else $("#lblSSkill").attr('class',"label label-gray");
                        }
                        else{ $("#lblSSkill").attr('class',"label label-inverse"); }

                        $("#hdSkill1").val(e[0].SkillFullScore);
                        $("#hdSkill2").val(e[0].SkillPercentage);
                        $("#hdCoach").val(e[0].IsCoaching);
                        if(e[0].IsCoaching == "1")
                        {
                            if(e[0].Coach_Count >= all_Count) $("#lblSCoach").attr('class',"label label-success");
                            else if ( e[0].Coach_Count > 0) $("#lblSCoach").attr('class',"label label-warning");
                            else $("#lblSCoach").attr('class',"label label-gray");
                        }
                        else{ $("#lblSCoach").attr('class',"label label-inverse"); }

                        $("#hdCert").val(e[0].IsAttachCert);
                        if(e[0].IsCertificate == "1")
                        {
                            if(e[0].Cert_Count >= all_Count) $("#lblSCert").attr('class',"label label-success");
                            else if ( e[0].Cert_Count > 0) $("#lblSCert").attr('class',"label label-warning");
                            else $("#lblSCert").attr('class',"label label-gray");
                        }
                        else{ $("#lblSCert").attr('class',"label label-inverse"); }

                        SearchCR();
                     }
                 },
            });
        }

        $("#chkAll").change(function() {
            var checked_status = this.checked;
            $('.scr').not("[disabled]").each(function () {
                   this.checked = checked_status;
            });
        });

        function AttendChange(sender)
        {
            //sender.alt ; sender.checked
            if($("#hdTest").val() == 1)
            {
                $("#txtPre"+sender.alt).prop('disabled', !sender.checked);
                $("#txtPost"+sender.alt).prop('disabled', !sender.checked);
            }

            if($("#hdSkill").val() == 1)
            {
                $("#txtSkill"+sender.alt).prop('disabled', !sender.checked);
            }

            if($("#hdCert").val() == 1)
            {

            }
        }

        function SearchCR() {
            $("#tbCourse tbody > tr").remove();
            $.ajax({
                type: 'POST',
                url: '@Url.Content("~/CourseRegister/GetCourseRegis")',
                data: {
                    "classID": '@ViewData["class"]',
                    "courseID": '@ViewData["course"]',
                    "employeeID": $('#txtEmpID').val(),
                    "employeeName": $('#txtEmpName').val(),
                    "departmentName": $('#txtDept').val(),
                    "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val()
                },
                dataType: 'json',
                success: function (e) {
                    if (e != null) {
                        for (var i = 0; i < e.length; i++) {

                            var row = $("<tr />");
                            $("#tbCourse tbody").append(row);
                            row.append("<td class='text-center'><input type='checkbox' class='scr' id='chkS" + e[i].EmployeeID + "' "+
                                (e[i].RegisterStatus == "70" || e[i].RegisterStatus == "10"? "disabled": "")+" alt='" + e[i].EmployeeID + "' /><label class='chk' for='chkS" + e[i].EmployeeID +"'>.</label> </td>");
                            row.append($("<td class='text-center'>" + (i + 1) + "</td>"));

                            row.append($("<td>" + e[i].EmployeeID + "</td>"));
                            row.append($("<td>" + e[i].Name + " " + e[i].Surname+"</td>"));
                            row.append($("<td>" + e[i].DepartmentName_TH + "</td>"));
                            row.append($("<td>" + e[i].JobGradeName_TH + "</td>"));
                            if (e[i].RegisterStatus == "70")
                                row.append($("<td class='text-center'><img src='@Url.Content("~/assets/images/svg/icon-check-green.svg")'/></td>"));
                            else
                                row.append($("<td class='text-center'><img src='@Url.Content("~/assets/images/svg/icon-cross-red.svg")'/></td>"));

                            if (e[i].RegisterStatus == "70" && $("#hdAttend").val() == 1) {

                                row.append("<td class='text-center'><input type='checkbox' id='chkA" + e[i].EmployeeID + "' "+
                                   (e[i].Attend > 0? "checked disabled" :"")+ " class='chk-att' alt='" + e[i].EmployeeID + "' onchange='AttendChange(this)'/><label class='chk' for='chkA" + e[i].EmployeeID + "'>.</label> </td>");
                            }
                            else
                                row.append("<td class='text-center'><input type='checkbox' class='chk-att' id='chkA" + e[i].EmployeeID + "' disabled alt='" + e[i].EmployeeID + "' onchange='AttendChange(this)' /><label class='chk' for='chkA" + e[i].EmployeeID + "'>.</label> </td>");

                            if(e[i].PreTestScore)
                            {
                                row.append("<td class='text-center'><input type='number' class='form-control text-right text-grid' id='txtPre"+e[i].EmployeeID+
                                    "' min='0' max='"+ $("#hdTest1").val()+"' value='"+e[i].PreTestScore+"' "+(e[i].Attend > 0 && $("#hdTest").val() == 1? "" :"disabled")+"/></td>");
                            }
                            else
                            {
                                row.append("<td class='text-center'><input type='number' class='form-control text-right text-grid' id='txtPre"+e[i].EmployeeID+
                                    "' min='0' max='"+ $("#hdTest1").val()+"' "+(e[i].Attend > 0 && $("#hdTest").val() == 1? "" :"disabled")+" /></td>");
                            }

                            if(e[i].PostTestScore)
                            {
                                row.append("<td class='text-center'><input type='number' class='form-control text-right text-grid' id='txtPost"+e[i].EmployeeID+
                                    "' min='0' max='"+ $("#hdTest1").val()+"' onblur='CalPostTest(this)' alt='" + e[i].EmployeeID + "' value='"+e[i].PostTestScore+"' "+(e[i].Attend > 0 && $("#hdTest").val() == 1? "" :"disabled")+"/></td>");

                                row.append("<td id='tdPPost"+e[i].EmployeeID+"' class='text-right'>"+ ((e[i].PostTestScore / ($("#hdTest1").val() *1))*100).toFixed(2) +"</td>");
                            }
                            else
                            {
                                row.append("<td class='text-center'><input type='number' class='form-control text-right text-grid' id='txtPost"+e[i].EmployeeID+
                                    "' min='0' max='"+ $("#hdTest1").val()+"' onblur='CalPostTest(this)' alt='" + e[i].EmployeeID + "' "+(e[i].Attend > 0 && $("#hdTest").val() == 1? "" :"disabled")+" /></td>");
                                row.append("<td id='tdPPost"+e[i].EmployeeID+"' class='text-right'></td>");
                            }

                            if(e[i].SkillScore)
                            {
                                row.append("<td class='text-center'><input type='number' class='form-control text-right text-grid' id='txtSkill"+e[i].EmployeeID+
                                    "'  min='0' max='"+ $("#hdSkill1").val()+"' onblur='CalSkill(this)' alt='" + e[i].EmployeeID + "' value='"+e[i].SkillScore+"' "+(e[i].Attend > 0 && $("#hdSkill").val() == 1? "" :"disabled")+"/></td>");

                                row.append("<td id='tdPSkill"+e[i].EmployeeID+"' class='text-right'>"+ ((e[i].SkillScore / ($("#hdSkill1").val() *1))*100).toFixed(2) +"</td>");
                            }
                            else
                            {
                                row.append("<td class='text-center'><input type='number' class='form-control text-right text-grid' id='txtSkill"+e[i].EmployeeID+
                                    "' min='0' max='"+ $("#hdSkill1").val()+"' onblur='CalSkill(this)' "+(e[i].Attend > 0 && $("#hdSkill").val() == 1? "" :"disabled")+" /></td>");
                                row.append("<td id='tdPSkill"+e[i].EmployeeID+"' class='text-right'></td>");
                            }
                            if(e[i].CoachingStatus == 1) row.append("<td class='text-center'><img src='@Url.Content("~/assets/images/svg/icon-check-green.svg")'/></td>"); else row.append("<td></td>");

                            if($("#hdCert").val() == 1)
                            {
                                if(e[i].ExpireDate)
                                    row.append("<td class='text-right'> <a id='aCert"+e[i].EmployeeID+
                                        "' href=\"javascript:OpenAttCert('"+e[i].EmployeeID+"', '"+ e[i].Certificate_Path+"', '"+e[i].ExpireDate_S+"');\"  class='text-info'> <small>"+
                                        e[i].ExpireDate+"</small> <i class='icon-paper-clip'></i> </a> </td>");
                                else
                                     row.append("<td class='text-right'> <a id='aCert"+e[i].EmployeeID+
                                         "' href=\"javascript:OpenAttCert('" + e[i].EmployeeID +"');\" class='text-info'> <i class='icon-paper-clip'></i> </a> </td>");
                            }

                            if($("#hdStatus").val() != "70")
                            {
                                row.append("<td "+(e[i].RegisterStatus == "70"? "class='text-info text-center font-weight-bold''" :"class='text-center font-weight-bold''")+">"+e[i].RegisterStatus_Name+"</td>");
                            }
                            else
                            {
                                var css = "class='text-center font-weight-bold''";
                                if(e[i].LearningResult == "70")  css = "class='text-info text-center font-weight-bold''";
                                else if(e[i].LearningResult == "99")  css = "class='text-danger text-center font-weight-bold''";

                                row.append("<td "+css+">"+e[i].LearningResult_Name+"</td>");
                            }
                        }
                    }
                }
            });
        }

        function CalPostTest(sender)
        {
            if(sender.value != "") $('#tdPPost'+sender.alt).html( ((sender.value * 1 / ($("#hdTest1").val() *1))*100).toFixed(2));
        }

        function CalSkill(sender)
        {
            if(sender.value != "") $('#tdPSkill'+sender.alt).html( ((sender.value * 1 / ($("#hdSkill1").val() *1))*100).toFixed(2));
        }

        $("#btnSave").click(function (e) {
            if(confirm('@LDMS.WEB.Resources.Message.e_CourseRegister_ConfirmSave'))
            {

                var lists = "";
                $('.chk-att').each(function () {
                    lists += this.alt+"|";
                    lists += (this.checked? "1":"0")+"|";

                    lists += $("#txtPre"+this.alt).val()+"|";
                    lists += $("#txtPost"+this.alt).val()+"|";
                    lists += $("#txtSkill"+this.alt).val();
                    lists += "#";
                });

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateAttendResult", "CourseRegister")',
                    data: { "classID": "@ViewData["class"]",
                            "courseID": "@ViewData["course"]",
                            "lists": lists,
                            "__RequestVerificationToken": $('input[name=__RequestVerificationToken]').val() },
                    success: function (e) {LoadClass(); SearchCR(); },
                });

            }
        });


        function OpenAttCert(empID,  path, date)
        {
            $('#hdCertEmp').val(empID);
            if(path)
            {
                $("#aFile").attr("href", path.replace("\\","/"));$("#aFile").show();
            }else $("#aFile").hide();
            $("#dpcCertExpire").val(null);
            if(date) $("#dpcCertExpire").val(date);
            $("#fiCert").val(null);
            $('#modCert').modal('toggle');
        }

        $('#frmCert').on('submit', function (e) {
            e.preventDefault();
            var form = $('#frmCert')[0];
            $.ajax({
                    type: 'post',
                    dataType: "JSON",
                    data: new FormData(form),
                    processData: false,
                    contentType: false,
                    url: '@Url.Action("UpdateCert", "CourseRegister")',
                    success: function (e) {
                        
                        LoadClass(); SearchCR(); $('#modCert').modal('toggle');
                    },
                    complete: function () {
                        LoadClass(); SearchCR(); $('#modCert').modal('toggle');
                    }
                });
        });
    </script>
}

